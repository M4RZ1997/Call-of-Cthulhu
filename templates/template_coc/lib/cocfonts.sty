\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{lettrine}
\RequirePackage[auto]{contour}
\RequirePackage{fontspec}

\bool_if:NT \l__coc_layout_bool
{
	\RequirePackage{bookman}
	\RequirePackage[type1]{gillius2}
	\RequirePackage[T1]{fontenc}
	\renewcommand{\sfdefault}{jkpss}
}

\cs_new_protected:Npn \__coc_sf_initial_family:
{
	\bool_if:NTF \l__coc_layout_bool
		{ \gilliustwo }
		{ \sffamily }
}


% #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#  Drop Cap Font  #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-# %
\newfontfamily\dropcapfont{GoudyInitialen}[%
	Path			=	\PATH templates/template_coc/fonts/goudy_initialen/,%
	Extension	=	.ttf,%
	UprightFont	=	GoudyInitialen,%
]%

\keys_define:nn { coc / fonts }
{
	% Drop caps
	drop-cap-family	.tl_set:N			= \l__coc_drop_cap_family_tl,
	drop-cap-family	.initial:n			= \dropcapfont,
	drop-cap-family	.value_required:n	= true,
	drop-cap-style	.tl_set:N			= \l__coc_drop_cap_style_tl,
	drop-cap-style	.value_required:n	= true,
}

\NewDocumentCommand { \CoCSetFonts } { o }
{
	\keys_set:nn { coc / fonts } { #1 }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Font access functions combine the selected family and style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Miscellaneous
\NewDocumentCommand{\CoCFontDropCap}{}
	{ \l__coc_drop_cap_family_tl \l__coc_drop_cap_style_tl }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Drop Caps
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\LettrineFontHook}
	{ \l__coc_drop_cap_family_tl \l__coc_drop_cap_style_tl }

% Usage: CoCDropCapLine[<lettrine options>]{<first letter>}{<small caps line>}
%    It takes trial and error to get the 2nd argument to align with
%    the linebreak. Lettrine package will not play nicely with \FirstLine. See
%    the lettrine package for options.
\NewDocumentCommand{\CoCDropCapLine}{ O{} m m }
{
	\lettrine[
		lines   = 4,
		depth   = 0,
		findent = \l__coc_space_dim,
		nindent = 0pt,
		#1
	]
	{#2}
	{#3}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Contour that can break across lines. Can accept \newline to force a break.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\cs_new_protected:Npn \__coc_contour_preserve_space:nn #1#2
{
	\group_begin:
	\seq_set_split:Nnn \l_tmpa_seq { ~ } { #2 }
	\seq_set_map:NNn \l_tmpb_seq \l_tmpa_seq { \exp_not:n {\contour{#1}{##1}} }
	\seq_use:Nn \l_tmpb_seq { ~ }
	\group_end:
}

\NewDocumentCommand{\CoCContour}{ O{contourgray} m }
{
	\group_begin:
	\seq_set_split:Nnn \l_tmpa_seq { \newline } { #2 }
	\seq_set_map:NNn \l_tmpb_seq \l_tmpa_seq { \exp_not:n {\__coc_contour_preserve_space:nn{#1}{##1}} }
	\seq_use:Nn \l_tmpb_seq { \newline }
	\group_end:
}